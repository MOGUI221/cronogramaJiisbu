{% extends 'base.html' %}

{% block content %}
<h2>Cronograma 29 de Abril</h2>
<div class="salones">
  {% for actividad in cronograma %}
  <div class="salon {% if actividad.es_especial %}evento-especial{% endif %}" id="salon-{{ loop.index }}">
    <div class="titulo-salon">{{ actividad.salon }}</div>
    <div class="actividad">{{ actividad.nombre }}</div>
    <div class="horario">🕒 {{ actividad.inicio }} - {{ actividad.fin }}</div>
    <div class="encargado">{{ actividad.encargado }}</div>
    
    {% if not actividad.es_especial %}
    <div class="registro">
        <span class="contador-participantes" id="contador-{{ loop.index }}">0</span> participantes<br>
        <button class="registro-btn" onclick="registrarAsistencia({{ loop.index }})" data-id="{{ loop.index }}">
            {% if actividad.id in localStorage and localStorage.getItem(actividad.id) === 'true' %}Cancelar Registro{% else %}Registrar asistencia{% endif %}
        </button>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<script>
// Función para registrar o cancelar la asistencia
function registrarAsistencia(id) {
    // Obtener el estado actual del registro
    const estado = localStorage.getItem("registro-" + id);

    // Comprobar si el usuario ya está registrado
    if (estado === "true") {
        // Si ya está registrado, cancelar el registro
        localStorage.setItem("registro-" + id, "false");
        document.querySelector("#contador-" + id).textContent--;
        document.querySelector("[data-id='" + id + "']").textContent = "Registrar asistencia";  // Cambiar el texto a "Registrar asistencia"
    } else {
        // Si no está registrado, hacer el registro
        localStorage.setItem("registro-" + id, "true");
        document.querySelector("#contador-" + id).textContent++;
        document.querySelector("[data-id='" + id + "']").textContent = "Cancelar Registro";  // Cambiar el texto a "Cancelar Registro"
    }
}

// Al cargar la página, comprobar el estado de cada actividad
window.onload = function() {
    {% for actividad in cronograma %}
    const id = {{ loop.index }};
    const estado = localStorage.getItem("registro-" + id);
    
    if (estado === "true") {
        // Si el usuario ya está registrado, actualizar el botón y contador
        document.querySelector("[data-id='" + id + "']").textContent = "Cancelar Registro";
        document.querySelector("#contador-" + id).textContent = parseInt(document.querySelector("#contador-" + id).textContent) + 1;
    } else {
        // Si el usuario no está registrado, asegurarse de que el texto es "Registrar asistencia"
        document.querySelector("[data-id='" + id + "']").textContent = "Registrar asistencia";
    }
    {% endfor %}
};
</script>
{% endblock %}
